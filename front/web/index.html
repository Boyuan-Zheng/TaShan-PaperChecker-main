<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PaperChecker Web æ§åˆ¶å° - ä»–å±±å­¦ç§‘äº¤å‰åˆ›æ–°åä¼š</title>
    <style>
        :root {
            /* ä»–å±±å“ç‰Œè‰² */
            --color-primary: #5B9BD5;
            --color-secondary: #9FD4C4;
            --color-accent: #6BC5D6;
            --color-accent-light: #B5E5C8;
            
            /* ä¸­æ€§è‰² */
            --color-dark: #0E2E4F;
            --color-darker: #0A1F35;
            --color-light: #FFFFFF;
            --color-gray: #6C757D;
            --color-gray-light: #E9ECEF;
            --color-gray-dark: #495057;
            
            /* æ¸å˜ */
            --gradient-primary: linear-gradient(135deg, #5B9BD5 0%, #9FD4C4 100%);
            --gradient-secondary: linear-gradient(135deg, #6BC5D6 0%, #B5E5C8 100%);
            --gradient-accent: linear-gradient(135deg, #5B9BD5 0%, #B5E5C8 100%);
            
            /* é˜´å½± */
            --shadow-sm: 0 2px 8px rgba(15, 46, 79, 0.08);
            --shadow-md: 0 4px 16px rgba(15, 46, 79, 0.12);
            --shadow-lg: 0 8px 32px rgba(15, 46, 79, 0.15);
            --shadow-accent: 0 4px 16px rgba(107, 197, 214, 0.25);
            
            /* åœ†è§’ */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 32px;
            
            /* åŠ¨æ•ˆ */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            color-scheme: light dark;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif;
        }
        body {
            margin: 0;
            padding: 32px;
            background: #f8f9fb;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .card {
            width: min(900px, 100%);
            background: #fff;
            border-radius: var(--radius-xl);
            padding: 40px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-gray-light);
        }
        h1 {
            margin: 0 0 12px;
            font-size: 2.2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        p.desc {
            margin: 0 0 8px;
            color: var(--color-gray);
            line-height: 1.6;
            font-size: 1rem;
        }
        p.desc-highlight {
            margin: 0 0 24px;
            color: var(--color-primary);
            font-weight: 600;
            font-size: 0.95rem;
        }
        label {
            display: block;
            font-weight: 600;
            color: var(--color-dark);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        input[type="text"],
        input[type="file"] {
            width: 100%;
            border: 1px solid var(--color-gray-light);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 16px;
            transition: var(--transition);
        }
        input[type="text"]:focus,
        input[type="file"]:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(91, 155, 213, 0.1);
        }
        input[type="radio"] {
            width: auto;
            accent-color: var(--color-primary);
        }
        button {
            border: none;
            background: var(--gradient-primary);
            color: #fff;
            padding: 12px 24px;
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            background: var(--color-gray-light);
            color: var(--color-gray);
        }
        button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: var(--gradient-accent);
        }
        button:not(:disabled):active {
            transform: translateY(0);
        }
        .progress {
            margin-top: 24px;
        }
        .progress-label {
            font-size: 0.9rem;
            color: var(--color-gray);
            margin-bottom: 8px;
            font-weight: 500;
        }
        .progress-bar {
            height: 10px;
            border-radius: var(--radius-sm);
            background: var(--color-gray-light);
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .progress-bar span {
            display: block;
            height: 100%;
            width: 0%;
            background: var(--gradient-primary);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 8px rgba(91, 155, 213, 0.3);
        }
        .log {
            margin-top: 30px;
            background: var(--color-darker);
            color: var(--color-gray-light);
            border-radius: var(--radius-md);
            padding: 20px;
            min-height: 150px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            overflow-y: auto;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .result {
            margin-top: 24px;
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid rgba(91, 155, 213, 0.2);
            background: linear-gradient(135deg, rgba(91, 155, 213, 0.03) 0%, rgba(159, 212, 196, 0.03) 100%);
            color: var(--color-dark);
            box-shadow: var(--shadow-sm);
        }
        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 16px;
        }
        .result h2 {
            margin-top: 0;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--color-dark);
        }
        .result-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }
        .result-md {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px dashed #bfdbfe;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* ä¸ºæ¸²æŸ“çš„ Markdown å†…å®¹æ·»åŠ æ ·å¼ */
        .result-md h1,
        .result-md h2,
        .result-md h3,
        .result-md h4,
        .result-md h5,
        .result-md h6 {
            margin: 1em 0 0.5em 0;
            font-weight: bold;
        }
        .result-md p {
            margin: 0.8em 0;
        }
        .result-md ul,
        .result-md ol {
            margin: 0.8em 0;
            padding-left: 1.5em;
        }
        .result-md li {
            margin: 0.3em 0;
        }
        .result-md pre {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
        }
        .result-md code {
            font-family: 'Monaco', 'Consolas', monospace;
            background: #f1f5f9;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .result-md blockquote {
            border-left: 3px solid #94a3b8;
            padding-left: 12px;
            margin: 1em 0;
            color: #64748b;
        }
        .result-md pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            overflow-x: auto;
        }
        /* ä¸ºç›´æ¥æ¸²æŸ“çš„ HTML å†…å®¹æ·»åŠ æ ·å¼ */
        .result-md > h1 {
            font-size: 1.5em;
            margin: 0.8em 0 0.5em 0;
            color: #0f172a;
        }
        .result-md > h2 {
            font-size: 1.3em;
            margin: 1em 0 0.5em 0;
            color: #334155;
        }
        .result-md > p {
            margin: 0.5em 0;
            line-height: 1.5;
        }
        .result-md table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }
        .result-md table,
        .result-md th,
        .result-md td {
            border: 1px solid var(--color-gray-light);
        }
        .result-md th,
        .result-md td {
            padding: 0.6em 0.8em;
            text-align: left;
        }
        .result-md th {
            background: var(--gradient-primary);
            color: #fff;
            font-weight: 600;
        }
        .result-md tr:hover {
            background: rgba(91, 155, 213, 0.05);
        }
        .result-chip {
            padding: 8px 16px;
            border-radius: var(--radius-lg);
            background: var(--gradient-primary);
            color: #fff;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        /* å…³äºæ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .modal-content h2 {
            margin-top: 0;
            color: var(--color-dark);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .modal-content p {
            margin: 0.8em 0;
        }
        .modal-content ul,
        .modal-content ol {
            margin: 0.8em 0;
            padding-left: 1.5em;
        }
        .modal-content li {
            margin: 0.3em 0;
        }
        .modal-content h1,
        .modal-content h2,
        .modal-content h3,
        .modal-content h4 {
            margin: 1em 0 0.5em 0;
            font-weight: bold;
        }
        .modal-content pre {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1em 0;
        }
        .modal-content code {
            font-family: 'Monaco', 'Consolas', monospace;
            background: #f1f5f9;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .modal-content blockquote {
            border-left: 3px solid #94a3b8;
            padding-left: 12px;
            margin: 1em 0;
            color: #64748b;
        }
        .modal-content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
            .card {
                padding: 24px;
            }
            h1 {
                font-size: 1.6rem;
            }
            .modal-content {
                width: 95%;
                max-height: 90vh;
            }
            button {
                font-size: 0.9rem;
                padding: 10px 18px;
            }
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>PaperChecker å­¦æœ¯è®ºæ–‡å¼•ç”¨æ£€æŸ¥å·¥å…·</h1>
        <p class="desc">ç”±ä¸­å›½ç§‘å­¦é™¢å¤§å­¦ä»–å±±å­¦ç§‘äº¤å‰åˆ›æ–°åä¼š Agent4S é¡¹ç›®ç»„å¼€å‘</p>
        <p class="desc">è‡ªåŠ¨æ£€æµ‹å’ŒéªŒè¯å­¦æœ¯æ–‡æ¡£ä¸­çš„å¼•ç”¨æ ¼å¼ä¸å‚è€ƒæ–‡çŒ®ä¸€è‡´æ€§ï¼Œä¸“æ³¨äº <strong>GB/T 7714-2015 è‘—è€…-å‡ºç‰ˆå¹´åˆ¶</strong> æ ¼å¼çš„æ™ºèƒ½åŒ¹é…ä¸åˆ†æ</p>
        <p class="desc-highlight">âœ“ æ”¯æŒ Word (.doc/.docx) å’Œ PDF æ–‡æ¡£ &nbsp;|&nbsp; âœ“ å®æ—¶åˆ†æè¿›åº¦å±•ç¤º &nbsp;|&nbsp; âœ“ è¯¦ç»†æŠ¥å‘Šå¯¼å‡º</p>

        <label for="file-input">å¾…åˆ†ææ–‡æ¡£ï¼ˆ.doc / .docx / .pdfï¼‰</label>
        <input id="file-input" type="file" accept=".doc,.docx,.docm,.dot,.dotx,.dotm,.pdf">

        <!-- æ ¼å¼è§„åˆ™é…ç½®åŒºåŸŸ -->
        <label for="author-format-options">ä½œè€…ç½²åæ ¼å¼è§„åˆ™ï¼ˆGB/T 7714-2015 æ ‡å‡†ï¼‰</label>
        <div id="author-format-options" style="border: 1px solid var(--color-gray-light); border-radius: var(--radius-md); padding: 18px; margin-bottom: 20px; background: linear-gradient(135deg, rgba(91, 155, 213, 0.03) 0%, rgba(159, 212, 196, 0.03) 100%);">
            <div style="margin-bottom: 14px;">
                <input type="radio" id="author-format-full" name="author-format" value="full" checked>
                <label for="author-format-full" style="display: inline; font-weight: normal; margin-left: 8px; color: var(--color-gray-dark);">
                    <strong>é€‰é¡¹ A</strong>ï¼šå½“æ–‡çŒ®ä½œè€…ä¸º 2 äººæ—¶ï¼Œå®Œæ•´åˆ—å‡ºä¸¤ä½ä½œè€…çš„å§“åï¼ˆå¦‚ï¼šå¼ ä¸‰ & æå››ï¼ˆ2024ï¼‰ï¼‰
                </label>
            </div>
            <div>
                <input type="radio" id="author-format-abbrev" name="author-format" value="abbrev">
                <label for="author-format-abbrev" style="display: inline; font-weight: normal; margin-left: 8px; color: var(--color-gray-dark);">
                    <strong>é€‰é¡¹ B</strong>ï¼šå½“æ–‡çŒ®ä½œè€…ä¸º 2 äººæ—¶ï¼Œä»…æ ‡æ³¨ç¬¬ä¸€ä½œè€…å§“å + "ç­‰" å­—ï¼ˆå¦‚ï¼šå¼ ä¸‰ ç­‰ï¼ˆ2024ï¼‰ï¼‰
                </label>
            </div>
        </div>

        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
            <button id="upload-btn">ğŸ“¤ ä»…ä¸Šä¼ </button>
            <button id="citation-analyze-btn" disabled>ğŸ“Š å¼•ç”¨åˆ†æ</button>
            <button id="relevance-analyze-btn" disabled>ğŸ” ç›¸å…³æ€§åˆ†æ</button>
            <button id="delete-btn" style="background: linear-gradient(135deg, #e11d48, #f87171);">ğŸ—‘ï¸ æ¸…ç©ºæ–‡ä»¶</button>
            <button id="about-btn" style="background: linear-gradient(135deg, var(--color-gray), var(--color-gray-dark));">â„¹ï¸ å…³äº</button>
        </div>

        <!-- ç›¸å…³æ€§æ£€æŸ¥åŠŸèƒ½åŒºåŸŸ -->
        <div id="relevance-check-section" style="border: 1px solid var(--color-primary); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px; background: linear-gradient(135deg, rgba(91, 155, 213, 0.05) 0%, rgba(159, 212, 196, 0.05) 100%); box-shadow: var(--shadow-sm); display: none;">
            <h3 style="margin-top: 0; color: var(--color-dark); font-size: 1.2rem; font-weight: 700;">ğŸ” æ–‡çŒ®ç›¸å…³æ€§æ£€æŸ¥</h3>

            <p style="margin-top: 0; margin-bottom: 16px; color: var(--color-gray-dark);">ğŸ“„ åˆ†ææ–‡æ¡£ï¼š<strong id="relevance-doc-name" style="color: var(--color-primary);">æœªé€‰æ‹©æ–‡æ¡£</strong></p>

            <label for="selected-citation">é€‰æ‹©è¦æ£€æŸ¥çš„æ–‡çŒ®</label>
            <select id="selected-citation" style="width: 100%; border: 1px solid var(--color-gray-light); border-radius: var(--radius-md); padding: 10px 14px; font-size: 1rem; box-sizing: border-box; margin-bottom: 16px; transition: var(--transition);">
                <option value="">è¯·é€‰æ‹©æ–‡çŒ®...</option>
            </select>

            <label for="task-type">æ£€æŸ¥ç±»å‹</label>
            <div style="margin-bottom: 16px;">
                <input type="radio" id="task-type-article" name="task-type" value="æ–‡ç« æ•´ä½“" checked>
                <label for="task-type-article" style="display: inline; font-weight: normal; margin-right: 16px;">å½“å‰æ–‡æ¡£æ•´ä½“</label>

                <input type="radio" id="task-type-paragraph" name="task-type" value="æ®µè½">
                <label for="task-type-paragraph" style="display: inline; font-weight: normal;">å½“å‰æ–‡æ¡£æ®µè½</label>
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="quick-check-btn" disabled>å¿«é€Ÿæ£€æµ‹ï¼ˆåŸºäºæ ‡é¢˜ï¼‰</button>
                <button id="accurate-check-btn" disabled>å‡†ç¡®æ£€æŸ¥ï¼ˆåŸºäºå…¨æ–‡ï¼‰</button>
            </div>
        </div>

        <div class="progress">
            <div class="progress-label">ä¸Šä¼ è¿›åº¦</div>
            <div class="progress-bar"><span id="upload-progress"></span></div>
        </div>
        <div class="progress">
            <div class="progress-label">åˆ†æè¿›åº¦</div>
            <div class="progress-bar"><span id="analysis-progress"></span></div>
        </div>

        <div class="result" style="margin-top: 24px;">
            <div class="result-header">
                <h2>ğŸ“ ä¸Šä¼ æ–‡ä»¶ç®¡ç†</h2>
                <button id="refresh-files-btn" style="padding: 8px 16px; font-size: 0.9rem; background: var(--gradient-secondary);">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div id="file-list-container">
                <p>ç‚¹å‡»"åˆ·æ–°æ–‡ä»¶åˆ—è¡¨"æŒ‰é’®æŸ¥çœ‹å½“å‰ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶</p>
            </div>
        </div>

        <div id="result" class="result" hidden>
            <div class="result-header">
                <h2>ğŸ“Š åˆ†æç»“æœæ‘˜è¦</h2>
                <div style="display: flex; gap: 8px;">
                    <button id="download-md-btn" style="padding: 8px 16px; font-size: 0.9rem; background: var(--gradient-secondary);">ğŸ“¥ ä¸‹è½½ Markdown</button>
                    <button id="download-txt-btn" style="padding: 8px 16px; font-size: 0.9rem; background: var(--gradient-secondary);">ğŸ“„ ä¸‹è½½ TXT</button>
                </div>
            </div>
            <div class="result-grid" id="result-grid"></div>
            <div id="result-raw" class="result-md"></div>
        </div>

        <div class="log" id="log">ğŸ’¡ ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æ“ä½œ...</div>
    </div>

    <script src="./marked.min.js"></script>
    <script src="./highlight.min.js"></script>
    <link rel="stylesheet" href="./default.min.css">
    <script>
        // é…ç½® marked åº“é€‰é¡¹ä»¥æ”¯æŒä»£ç é«˜äº®
        marked.setOptions({
            gfm: true, // å¯ç”¨ GitHub flavored markdown
            breaks: false, // ä¸å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br>
            smartLists: true, // ä½¿ç”¨æ™ºèƒ½åˆ—è¡¨
            smartypants: false, // ä¸è½¬æ¢å¼•å·ã€ç ´æŠ˜å·ç­‰ä¸ºæ’ç‰ˆç¬¦å·
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            }
        });
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        const citationAnalyzeBtn = document.getElementById('citation-analyze-btn');
        const relevanceAnalyzeBtn = document.getElementById('relevance-analyze-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const refreshFilesBtn = document.getElementById('refresh-files-btn');
        const fileListContainer = document.getElementById('file-list-container');
        const uploadProgress = document.getElementById('upload-progress');
        const analysisProgress = document.getElementById('analysis-progress');
        const logBox = document.getElementById('log');
        const resultBox = document.getElementById('result');
        const resultGrid = document.getElementById('result-grid');
        const resultRaw = document.getElementById('result-raw');
        const downloadMdBtn = document.getElementById('download-md-btn');
        const downloadTxtBtn = document.getElementById('download-txt-btn');

        // å½“å‰é€‰ä¸­çš„æ–‡ä»¶è·¯å¾„
        let selectedFilePath = null;

        // è·å–ä½œè€…æ ¼å¼é€‰é¡¹å…ƒç´ 
        const authorFormatFull = document.getElementById('author-format-full');
        const authorFormatAbbrev = document.getElementById('author-format-abbrev');

        let lastMarkdown = "";

        const defaultBase = window.location.origin.includes('http')
            ? window.location.origin
            : 'http://127.0.0.1:8000';

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logBox.textContent = '[' + timestamp + '] ' + message + '\n' + logBox.textContent;
        }

        function setBar(bar, percent) {
            const value = Math.min(100, Math.max(0, percent));
            bar.style.width = value + '%';
        }

        // HTML è½¬æ¢ JSON å¯¹è±¡ä¸ºç»“æ„åŒ–æ–‡æœ¬æ ¼å¼
        function convertJsonToText(obj, indentLevel = 0) {
            const indent = '&nbsp;'.repeat(indentLevel * 4); // 4ä¸ªç©ºæ ¼çš„ç¼©è¿›
            let result = '';

            if (obj === null) {
                return 'null';
            } else if (typeof obj === 'undefined') {
                return 'undefined';
            } else if (typeof obj === 'string' || typeof obj === 'number' || typeof obj === 'boolean') {
                return escapeHtml(String(obj));
            } else if (Array.isArray(obj)) {
                if (obj.length === 0) {
                    return '[]';
                }
                result += '[<br>';
                obj.forEach((item, index) => {
                    result += indent + '&nbsp;&nbsp;&nbsp;&nbsp;' + convertJsonToText(item, indentLevel + 1);
                    if (index < obj.length - 1) {
                        result += ',<br>';
                    } else {
                        result += '<br>';
                    }
                });
                result += indent + ']';
            } else if (typeof obj === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) {
                    return '{}';
                }
                result += '{<br>';
                keys.forEach((key, index) => {
                    const value = obj[key];
                    result += indent + '&nbsp;&nbsp;&nbsp;&nbsp;"' + escapeHtml(key) + '": ' + convertJsonToText(value, indentLevel + 1);
                    if (index < keys.length - 1) {
                        result += ',<br>';
                    } else {
                        result += '<br>';
                    }
                });
                result += indent + '}';
            }
            return result;
        }

        // å°† payload è½¬æ¢ä¸ºç»“æ„åŒ–çš„ Markdown æŠ¥å‘Šæ ¼å¼
        function convertPayloadToMarkdown(payload) {
            let result = '# PaperChecker å¼•ç”¨åˆ†ææŠ¥å‘Š\n\n';

            if (payload.document) {
                // æå–æ–‡ä»¶åè€Œä¸æ˜¯å®Œæ•´è·¯å¾„
                const documentFileName = payload.document.split('/').pop();
                result += `- **æ–‡æ¡£**: ${escapeHtml(documentFileName)}\n`;
            }
            if (payload.test_date) {
                // æ ¼å¼åŒ–æ—¥æœŸä¸º "YYYYå¹´MMæœˆDDæ—¥ HH:mm:ss" æ ¼å¼
                const date = new Date(payload.test_date);
                const formattedDate = `${date.getFullYear()}å¹´${(date.getMonth() + 1).toString().padStart(2, '0')}æœˆ${date.getDate().toString().padStart(2, '0')}æ—¥ ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
                result += `- **ç”Ÿæˆæ—¶é—´**: ${formattedDate}\n\n`;
            }

            result += '**æ•´ä½“ç»Ÿè®¡**\n\n';
            result += '| æŒ‡æ ‡ | æ•°å€¼ |\n';
            result += '| --- | --- |\n';
            if (payload.total_citations) result += `| å¼•ç”¨æ€»æ•° | ${payload.total_citations} |\n`;
            if (payload.total_references) result += `| å‚è€ƒæ–‡çŒ®æ•° | ${payload.total_references} |\n`;
            if (payload.matched_count) result += `| åŒ¹é…æ¡ç›® | ${payload.matched_count} |\n`;
            if (payload.unmatched_count) result += `| æœªåŒ¹é…æ¡ç›® | ${payload.unmatched_count} |\n`;
            if (payload.corrected_count) result += `| éœ€è¦ä¿®æ­£ | ${payload.corrected_count} |\n`;
            if (payload.formatted_count) result += `| éœ€è¦æ ¼å¼åŒ– | ${payload.formatted_count} |\n`;
            if (payload.match_rate) result += `| åŒ¹é…ç‡ | ${payload.match_rate} |\n`;
            result += '\n';

            // ä¿®æ­£çš„å¼•ç”¨
            if (payload.corrections_needed && payload.corrections_needed.length > 0) {
                result += '**éœ€è¦ä¿®æ­£çš„å¼•ç”¨**\n\n';
                payload.corrections_needed.forEach(item => {
                    result += `- **åŸæ–‡**: ${escapeHtml(removeAuthPrefix(item.original || ''))}\n- **ä¿®æ­£**: ${escapeHtml(removeAuthPrefix(item.corrected || ''))}\n- **å‚è€ƒæ–‡çŒ®**: ${escapeHtml(item.reference || '').substring(0, 100)}...\n`;
                });
                result += '\n';
            }

            // æ ¼å¼åŒ–éœ€è¦çš„å¼•ç”¨
            if (payload.formatting_needed && payload.formatting_needed.length > 0) {
                result += '**éœ€è¦æ ¼å¼åŒ–çš„å¼•ç”¨**\n\n';
                payload.formatting_needed.forEach(item => {
                    result += `- **åŸæ–‡**: ${escapeHtml(removeAuthPrefix(item.original || ''))}\n- **æ ¼å¼åŒ–**: ${escapeHtml(removeAuthPrefix(item.formatted || ''))}\n- **å‚è€ƒæ–‡çŒ®**: ${escapeHtml(item.reference || '').substring(0, 100)}...\n`;
                });
                result += '\n';
            }

            // æœªè¢«å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®
            if (payload.unused_references && payload.unused_references.length > 0) {
                result += '**æœªè¢«å¼•ç”¨çš„å‚è€ƒæ–‡çŒ®**\n\n';
                payload.unused_references.forEach(item => {
                    result += `- **æ–‡æœ¬**: ${escapeHtml(item.text || '')}\n`;
                });
                result += '\n';
            }

            // å¼•ç”¨è¯¦æƒ…
            if (payload.results && payload.results.length > 0) {
                result += '**å¼•ç”¨è¯¦æƒ…**\n\n';
                payload.results.forEach((item, index) => {
                    result += `**å¼•ç”¨ ${index + 1}**\n`;
                    result += `- åŸå§‹å¼•ç”¨: ${escapeHtml(removeAuthPrefix(item.original_citation || ''))}\n`;
                    result += `- åŒ¹é…çŠ¶æ€: ${item.matched ? 'å·²åŒ¹é…' : 'æœªåŒ¹é…'}\n`;

                    if (item.matched) {
                        if (item.reference_text) {
                            result += `- å‚è€ƒæ–‡çŒ®: ${escapeHtml(item.reference_text)}\n`;
                        }

                        if (item.needs_correction && item.corrected_citation) {
                            result += `- å»ºè®®ä¿®æ­£: ${escapeHtml(item.corrected_citation)}\n`;
                            if (item.correction_reason) {
                                result += `- åŸå› : ${escapeHtml(item.correction_reason)}\n`;
                            }
                        }

                        if (item.needs_formatting && item.formatted_citation) {
                            result += `- å»ºè®®æ ¼å¼åŒ–: ${escapeHtml(item.formatted_citation)}\n`;
                            if (item.formatting_reason) {
                                result += `- åŸå› : ${escapeHtml(item.formatting_reason)}\n`;
                            }
                        }
                    }
                    result += '\n';
                });
            }

            return result;
        }

        // HTML è½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢ XSS æ”»å‡»å’Œè§£æé”™è¯¯ï¼Œå¤„ç†æ‰€æœ‰æ•°æ®ç±»å‹
        // å°† Markdown å†…å®¹è½¬æ¢ä¸ºçº¯æ–‡æœ¬
        function convertMdToTxt(markdown) {
            // ç§»é™¤ Markdown æ ¼å¼æ ‡è®°
            return markdown
                // ç§»é™¤æ ‡é¢˜æ ‡è®°
                .replace(/^#+\s*/gm, '')
                // ç§»é™¤ç²—ä½“æ ‡è®°
                .replace(/\*\*(.*?)\*\*/g, '$1')
                .replace(/__(.*?)__/g, '$1')
                // ç§»é™¤æ–œä½“æ ‡è®°
                .replace(/\*(.*?)\*/g, '$1')
                .replace(/_(.*?)_/g, '$1')
                // ç§»é™¤åˆ é™¤çº¿æ ‡è®°
                .replace(/~~(.*?)~~/g, '$1')
                // ç§»é™¤è¡Œå†…ä»£ç æ ‡è®°
                .replace(/`(.*?)`/g, '$1')
                // ç§»é™¤é“¾æ¥å’Œå›¾ç‰‡æ ‡è®°ï¼Œä¿ç•™æ–‡å­—
                .replace(/!\[([^\]]*)\]\([^)]*\)/g, '$1')  // å›¾ç‰‡
                .replace(/\[([^\]]+)\]\([^)]*\)/g, '$1')    // é“¾æ¥
                // ç§»é™¤æ— åºåˆ—è¡¨æ ‡è®°
                .replace(/^\s*-\s+/gm, '')
                .replace(/^\s*\*\s+/gm, '')
                .replace(/^\s*\+\s+/gm, '')
                // ç§»é™¤æœ‰åºåˆ—è¡¨æ ‡è®°
                .replace(/^\s*\d+\.\s+/gm, '')
                // å¤„ç†è¡¨æ ¼ï¼ˆä¿ç•™å†…å®¹ï¼Œç§»é™¤è¡¨æ ¼æ ¼å¼ï¼‰
                .replace(/^\|(.+)\|$/gm, function(match, content) {
                    return content.replace(/\s*\|\s*/g, ' | ');
                })
                // æ¸…ç†å¤šä½™çš„ç©ºç™½è¡Œ
                .replace(/\n\s*\n/g, '\n\n');
        }

        function escapeHtml(text) {
            // ç¡®ä¿è¾“å…¥æ˜¯å­—ç¬¦ä¸²ç±»å‹
            const str = String(text);
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/`/g, "&#96;"); // è½¬ä¹‰åå¼•å·ï¼Œé¿å…ä¸ Markdown å†²çª
        }

        function removeAuthPrefix(text) {
            if (typeof text === 'string' && text.startsWith('[AUTH:')) {
                return text.substring(6, text.length - 1); // å»æ‰[AUTH:å¼€å¤´å’Œ]ç»“å°¾
            }
            return text;
        }

        function renderResult(payload) {
            resultGrid.innerHTML = '';

            // ç¡®ä¿ marked åº“å¯ç”¨
            if (typeof marked === 'undefined') {
                log('é”™è¯¯ï¼šmarked åº“æœªåŠ è½½');
                resultRaw.textContent = 'Markdown æ¸²æŸ“åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                resultBox.hidden = false;
                return;
            }

            // ä¼˜å…ˆå±•ç¤ºåç«¯ç”Ÿæˆçš„ Markdown æ–‡æœ¬ï¼Œè€Œä¸æ˜¯åŸå§‹ JSON ä»£ç 
            if (payload && typeof payload.markdown === 'string' && payload.markdown.trim()) {
                lastMarkdown = payload.markdown;
                try {
                    // ä½¿ç”¨ marked åº“å°† Markdown æ¸²æŸ“ä¸º HTML
                    const renderedHTML = marked.parse(payload.markdown);
                    resultRaw.innerHTML = renderedHTML;
                } catch (error) {
                    console.error('Markdown è§£æé”™è¯¯:', error);
                    // å¦‚æœè§£æå¤±è´¥ï¼Œå›é€€åˆ°æ˜¾ç¤ºåŸå§‹ Markdown æ–‡æœ¬
                    resultRaw.textContent = payload.markdown;
                }
                downloadMdBtn.style.display = 'inline-block';
                downloadTxtBtn.style.display = 'inline-block';
            } else {
                // å®Œå…¨ä½¿ç”¨ç›´æ¥ HTML æ¸²æŸ“ï¼Œä¸ä¾èµ– Markdown è§£æ
                let htmlContent = '<h1>åˆ†æç»“æœ</h1>';

                if (payload.match_rate !== undefined && payload.match_rate !== null) htmlContent += '<p><strong>åŒ¹é…ç‡ï¼š</strong> ' + escapeHtml(payload.match_rate) + '</p>';
                if (payload.total_citations !== undefined && payload.total_citations !== null) htmlContent += '<p><strong>å¼•ç”¨æ€»æ•°ï¼š</strong> ' + escapeHtml(payload.total_citations) + '</p>';
                if (payload.total_references !== undefined && payload.total_references !== null) htmlContent += '<p><strong>å‚è€ƒæ–‡çŒ®ï¼š</strong> ' + escapeHtml(payload.total_references) + '</p>';
                if (payload.matched_count !== undefined && payload.matched_count !== null) htmlContent += '<p><strong>å·²åŒ¹é…ï¼š</strong> ' + escapeHtml(payload.matched_count) + '</p>';
                if (payload.unmatched_count !== undefined && payload.unmatched_count !== null) htmlContent += '<p><strong>æœªåŒ¹é…ï¼š</strong> ' + escapeHtml(payload.unmatched_count) + '</p>';
                if (payload.corrected_count !== undefined && payload.corrected_count !== null) htmlContent += '<p><strong>çº æ­£æ•°ï¼š</strong> ' + escapeHtml(payload.corrected_count) + '</p>';
                if (payload.formatted_count !== undefined && payload.formatted_count !== null) htmlContent += '<p><strong>æ ¼å¼åŒ–å»ºè®®ï¼š</strong> ' + escapeHtml(payload.formatted_count) + '</p>';

                // ç”Ÿæˆç»“æ„åŒ–çš„ Markdown å†…å®¹
                const markdownContent = convertPayloadToMarkdown(payload);

                // ä½¿ç”¨ marked åº“å°† Markdown æ¸²æŸ“ä¸º HTML
                const renderedHTML = marked.parse(markdownContent);

                // æ·»åŠ åˆ°é¡µé¢
                htmlContent += '<h2>è¯¦ç»†æ•°æ®</h2>';
                htmlContent += '<div class="detailed-data">' + renderedHTML + '</div>';

                resultRaw.innerHTML = htmlContent;

                // ä¿å­˜åŸå§‹ Markdown å†…å®¹ç”¨äºä¸‹è½½
                lastMarkdown = markdownContent;

                downloadMdBtn.style.display = 'inline-block';

                // åŒæ—¶æ˜¾ç¤ºä¸‹è½½ TXT æŒ‰é’®
                downloadTxtBtn.style.display = 'inline-block';
            }

            const mapping = [
                ['åŒ¹é…ç‡', payload.match_rate],
                ['å¼•ç”¨æ€»æ•°', payload.total_citations],
                ['å‚è€ƒæ–‡çŒ®', payload.total_references],
                ['å·²åŒ¹é…', payload.matched_count],
                ['æœªåŒ¹é…', payload.unmatched_count],
                ['çº æ­£æ•°', payload.corrected_count],
                ['æ ¼å¼åŒ–å»ºè®®', payload.formatted_count],
            ];

            mapping.forEach(([label, value]) => {
                if (value === undefined || value === null || value === '') return;
                const chip = document.createElement('div');
                chip.className = 'result-chip';
                chip.textContent = label + 'ï¼š' + value;
                resultGrid.appendChild(chip);
            });

            resultBox.hidden = false;
        }

        // ä¸‹è½½ Markdown æŠ¥å‘Š
        downloadMdBtn.addEventListener('click', () => {
            if (!lastMarkdown) {
                log('å½“å‰æ²¡æœ‰å¯ä¸‹è½½çš„æŠ¥å‘Šå†…å®¹ã€‚');
                return;
            }
            const blob = new Blob([lastMarkdown], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const file = fileInput.files[0];
            const baseName = file ? file.name.replace(/\.[^.]+$/, '') : 'paperchecker-report';
            a.href = url;
            a.download = baseName + '_citation_report.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // ä¸‹è½½ TXT æŠ¥å‘Š
        downloadTxtBtn.addEventListener('click', () => {
            if (!lastMarkdown) {
                log('å½“å‰æ²¡æœ‰å¯ä¸‹è½½çš„æŠ¥å‘Šå†…å®¹ã€‚');
                return;
            }
            const txtContent = convertMdToTxt(lastMarkdown);
            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const file = fileInput.files[0];
            const baseName = file ? file.name.replace(/\.[^.]+$/, '') : 'paperchecker-report';
            a.href = url;
            a.download = baseName + '_citation_report.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });








        // ä»æ–‡æ¡£ä¸­æå–å¼•ç”¨æ–‡çŒ®
        function extractCitationsFromDocument(filePath) {
            // æ¸…ç©ºæ–‡çŒ®é€‰æ‹©æ¡†
            const citationSelect = document.getElementById('selected-citation');
            citationSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ–‡çŒ®...</option>';

            // ä»åç«¯è·å–æ–‡æ¡£çš„å¼•ç”¨ä¿¡æ¯
            const serverUrl = defaultBase.trim().replace(/\/$/, '');
            const extractCitationsUrl = serverUrl + '/api/extract-citations';

            const formData = new FormData();
            formData.append('file_path', filePath);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', extractCitationsUrl, true);

            xhr.onreadystatechange = () => {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.citations && response.citations.length > 0) {
                                response.citations.forEach(citation => {
                                    const option = document.createElement('option');
                                    option.value = citation.text || citation;
                                    option.textContent = citation.text || citation;
                                    citationSelect.appendChild(option);
                                });

                                log(`æå–åˆ° ${response.citations.length} æ¡å¼•ç”¨æ–‡çŒ®`);
                            } else {
                                log('æ–‡æ¡£ä¸­æœªæ‰¾åˆ°å¼•ç”¨æ–‡çŒ®');
                            }
                        } catch (err) {
                            log('è§£æå¼•ç”¨æ–‡çŒ®å“åº”å¤±è´¥ï¼š' + err.message);
                        }
                    } else {
                        log('æå–å¼•ç”¨æ–‡çŒ®å¤±è´¥ï¼š' + (xhr.responseText || ('çŠ¶æ€ç  ' + xhr.status)));
                    }
                }
            };

            xhr.onerror = () => {
                log('ç½‘ç»œå¼‚å¸¸ï¼Œæå–å¼•ç”¨æ–‡çŒ®å¤±è´¥ã€‚');
            };

            xhr.send(formData);
        }

        // åˆ†æä»æ–‡ä»¶åˆ—è¡¨é€‰æ‹©çš„æ–‡ä»¶
        function analyzeFileFromList(filePath) {
            const serverUrl = defaultBase.trim().replace(/\/$/, '');
            const analyzeUrl = serverUrl + '/api/full-report-from-path';

            // è·å–å½“å‰é€‰ä¸­çš„ä½œè€…æ ¼å¼
            const selectedAuthorFormat = document.querySelector('input[name="author-format"]:checked').value;

            // åˆ›å»ºè¡¨å•æ•°æ®
            const formData = new FormData();
            formData.append('file_path', filePath);
            formData.append('author_format', selectedAuthorFormat);

            setBar(uploadProgress, 0);
            setBar(analysisProgress, 0);
            resultBox.hidden = true;
            log('å‡†å¤‡åˆ†ææ–‡ä»¶ï¼š' + filePath.split('/').pop() + 'ï¼Œä½œè€…æ ¼å¼è§„åˆ™ï¼š' + (selectedAuthorFormat === 'full' ? 'å®Œæ•´æ˜¾ç¤º' : 'ç®€ç•¥æ˜¾ç¤º'));

            citationAnalyzeBtn.disabled = true;

            // æ›´æ–°åˆ†ææŒ‰é’®çš„çŠ¶æ€
            const originalButtonText = citationAnalyzeBtn.textContent;
            citationAnalyzeBtn.textContent = 'åˆ†æä¸­...';

            const xhr = new XMLHttpRequest();

            // æ¨¡æ‹Ÿåˆ†æè¿›åº¦ï¼Œå› ä¸ºåç«¯ä¸æä¾›è¿›åº¦API
            const progressInterval = setInterval(() => {
                if (xhr.readyState < 4) {
                    // æ¨¡æ‹Ÿåˆ†æè¿›åº¦
                    const currentProgress = parseFloat(analysisProgress.style.width || '0');
                    if (currentProgress < 90) { // ä¸åˆ°100%ï¼Œå› ä¸ºæˆ‘ä»¬è¦ç­‰å¾…å®é™…å“åº”
                        setBar(analysisProgress, currentProgress + 2);
                    }
                }
            }, 500);

            xhr.onreadystatechange = () => {
                if (xhr.readyState !== XMLHttpRequest.DONE) return;

                clearInterval(progressInterval); // åœæ­¢æ¨¡æ‹Ÿè¿›åº¦

                // æ¢å¤åˆ†ææŒ‰é’®çš„åŸå§‹çŠ¶æ€
                citationAnalyzeBtn.disabled = false;
                citationAnalyzeBtn.textContent = originalButtonText;

                if (xhr.status === 200) {
                    setBar(uploadProgress, 100);
                    setBar(analysisProgress, 100);
                    log('åˆ†æå®Œæˆã€‚');
                    try {
                        const payload = JSON.parse(xhr.responseText);
                        renderResult(payload);
                    } catch (err) {
                        log('å“åº”è§£æå¤±è´¥ï¼š' + err.message);
                    }
                } else {
                    log('è¯·æ±‚å¤±è´¥ï¼š' + (xhr.responseText || ('çŠ¶æ€ç  ' + xhr.status)));
                }
            };

            xhr.onerror = () => {
                clearInterval(progressInterval); // åœæ­¢æ¨¡æ‹Ÿè¿›åº¦
                citationAnalyzeBtn.disabled = false;
                citationAnalyzeBtn.textContent = originalButtonText;
                log('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¡®è®¤åç«¯æœåŠ¡å¯è®¿é—®ã€‚');
            };

            xhr.open('POST', analyzeUrl, true);
            xhr.send(formData);
        }

        // åˆ é™¤å•ä¸ªæ–‡ä»¶
        function deleteSingleFile(filePath) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filePath.replace(/^.*[\\/]/, '')}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            const serverUrl = defaultBase.trim().replace(/\/$/, '');
            const deleteUrl = serverUrl + '/api/file?file_path=' + encodeURIComponent(filePath);

            const xhr = new XMLHttpRequest();
            xhr.open('DELETE', deleteUrl, true);

            xhr.onreadystatechange = () => {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                log(`æ–‡ä»¶åˆ é™¤æˆåŠŸ: ${filePath.replace(/^.*[\\/]/, '')}`);
                                // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                                loadFileList();
                            } else {
                                log(`æ–‡ä»¶åˆ é™¤å¤±è´¥: ${response.message || 'æœªçŸ¥é”™è¯¯'}`);
                            }
                        } catch (err) {
                            log('æ–‡ä»¶åˆ é™¤å“åº”è§£æå¤±è´¥ï¼š' + err.message);
                        }
                    } else {
                        log('æ–‡ä»¶åˆ é™¤å¤±è´¥ï¼š' + (xhr.responseText || ('çŠ¶æ€ç  ' + xhr.status)));
                    }
                }
            };

            xhr.onerror = () => {
                log('ç½‘ç»œå¼‚å¸¸ï¼Œæ–‡ä»¶åˆ é™¤å¤±è´¥ã€‚');
            };

            xhr.send();
        }


        // README å†…å®¹
        const readmeContent = `# å¼•æ–‡åˆè§„æ€§æ£€æŸ¥ç³»ç»Ÿ - åŠŸèƒ½ä»‹ç»

## ç³»ç»Ÿæ¦‚è¿°
è¿™æ˜¯ä¸€æ¬¾åŸºäºäººå·¥æ™ºèƒ½æŠ€æœ¯çš„å¼•æ–‡åˆè§„æ€§æ£€æŸ¥ç³»ç»Ÿï¼Œèƒ½å¤Ÿè‡ªåŠ¨åˆ†æå­¦æœ¯è®ºæ–‡ä¸­çš„å¼•æ–‡ä¸å‚è€ƒæ–‡çŒ®çš„åŒ¹é…æƒ…å†µï¼Œè¯†åˆ«ç¼ºå¤±ã€æ ¼å¼ä¸æ­£ç¡®æˆ–å¹´ä»½ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå¸®åŠ©ç ”ç©¶è€…æé«˜è®ºæ–‡è´¨é‡å’Œå­¦æœ¯è§„èŒƒæ€§ã€‚

## æ ¸å¿ƒåŠŸèƒ½

### 1. æ–‡æ¡£ä¸Šä¼ ä¸è§£æ
- **æ”¯æŒæ ¼å¼**ï¼šWord æ–‡æ¡£ï¼ˆ.docx, .docï¼‰
- **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼šæœ€å¤§ 10MB
- **æ™ºèƒ½è§£æ**ï¼šè‡ªåŠ¨è¯†åˆ«æ–‡æ¡£ç»“æ„ï¼Œæå–æ­£æ–‡å’Œå‚è€ƒæ–‡çŒ®éƒ¨åˆ†

### 2. æ ¼å¼å¼•æ–‡è¯†åˆ«

#### ä½œè€…-å¹´ä»½æ ¼å¼
- **ä¸­æ–‡æ ¼å¼**ï¼šå¼ ä¸‰ï¼ˆ2024ï¼‰ã€æå››ç­‰ï¼ˆ2023ï¼‰
- **è‹±æ–‡æ ¼å¼**ï¼šSmithï¼ˆ2020ï¼‰ã€Johnson & Brownï¼ˆ2021ï¼‰ã€Smith et al.ï¼ˆ2019ï¼‰
- **æ‹¬å·æ ¼å¼**ï¼šï¼ˆå¼ ä¸‰ï¼Œ2024ï¼‰ã€ï¼ˆSmith, 2020ï¼‰

### 3. æ™ºèƒ½å¼•ç”¨åŒ¹é…
- **åŒå‘æ˜ å°„**ï¼šå°†æ­£æ–‡ä¸­çš„å¼•æ–‡ä¸å‚è€ƒæ–‡çŒ®åˆ—è¡¨è¿›è¡Œç²¾ç¡®åŒ¹é…
- **æ™ºèƒ½è¯†åˆ«**ï¼šå³ä½¿æ ¼å¼ç•¥æœ‰å·®å¼‚ä¹Ÿèƒ½æ­£ç¡®åŒ¹é…
- **ä¸Šä¸‹æ–‡åˆ†æ**ï¼šåˆ†æå¼•æ–‡åœ¨æ­£æ–‡ä¸­çš„ä½¿ç”¨è¯­å¢ƒ

### 4. è‡ªåŠ¨åŒ–æ ¡éªŒä¸ä¿®æ­£
#### å¹´ä»½æ ¡éªŒ
- è‡ªåŠ¨æ£€æµ‹å¼•æ–‡å¹´ä»½ä¸å‚è€ƒæ–‡çŒ®å¹´ä»½çš„ä¸ä¸€è‡´æ€§
- ä¸ºä¸åŒ¹é…çš„å¼•æ–‡æä¾›æ­£ç¡®çš„å¹´ä»½

#### æ ¼å¼æ ‡å‡†åŒ–
- ç»Ÿä¸€å¼•æ–‡æ ¼å¼ï¼Œç¡®ä¿é£æ ¼ä¸€è‡´æ€§
- è§„èŒƒä½œè€…åç§°æ˜¾ç¤ºï¼ˆå¦‚å°†"å¼ ä¸‰ï¼Œæå››"è½¬æ¢ä¸º"å¼ ä¸‰ç­‰"ï¼‰

#### è´¨é‡æ£€æŸ¥
- è¯†åˆ«æœªåœ¨å‚è€ƒæ–‡çŒ®ä¸­å‡ºç°çš„å¼•æ–‡
- å‘ç°å‚è€ƒæ–‡çŒ®ä¸­æœªè¢«å¼•ç”¨çš„æ¡ç›®

### 5. è¯¦ç»†çš„åˆ†ææŠ¥å‘Š
ç³»ç»Ÿç”Ÿæˆå…¨é¢çš„åˆ†ææŠ¥å‘Šï¼ŒåŒ…æ‹¬ï¼š

#### åŒ¹é…ç»Ÿè®¡
- å¼•ç”¨æ•°é‡ç»Ÿè®¡
- åŒ¹é…æˆåŠŸç‡
- æœªåŒ¹é…å¼•ç”¨åˆ—è¡¨

#### ä¿®æ­£å»ºè®®
- å¹´ä»½ä¸ä¸€è‡´çš„ä¿®æ­£å»ºè®®
- æ ¼å¼æ ‡å‡†åŒ–å»ºè®®
- ç¼ºå¤±å¼•ç”¨æç¤º

#### å¼•ç”¨æ ¼å¼åŒ–
- æŒ‰ç…§ä¸åŒå­¦æœ¯æ ‡å‡†æ ¼å¼åŒ–å¼•ç”¨
- ç»Ÿä¸€ä½œè€…åˆ—è¡¨æ ¼å¼ï¼ˆå•ä½œè€…ã€å¤šä½œè€…ã€ç­‰/et al.ï¼‰

### 6. AI é©±åŠ¨çš„ä¼˜åŒ–
- **æ™ºèƒ½æ ¼å¼åŒ–**ï¼šä½¿ç”¨ AI æ¨¡å‹ä¼˜åŒ–å¼•ç”¨æ ¼å¼
- **é”™è¯¯å®¹å¿**ï¼šèƒ½å¤Ÿå¤„ç†éæ ‡å‡†æ ¼å¼å¹¶è‡ªåŠ¨çº æ­£
- **ä¸Šä¸‹æ–‡ç†è§£**ï¼šåˆ†æå¼•æ–‡åœ¨ä¸Šä¸‹æ–‡ä¸­çš„æ­£ç¡®æ€§

## æŠ€æœ¯ç‰¹æ€§

### é«˜ç²¾åº¦è¯†åˆ«
- æ”¯æŒå¤šç§ä¸­è‹±æ–‡å¼•ç”¨æ ¼å¼
- æ™ºèƒ½æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
- AI è¾…åŠ©å†…å®¹ç†è§£

### ç”¨æˆ·å‹å¥½
- ç®€å•çš„æ–‡æ¡£ä¸Šä¼ ç•Œé¢
- æ¸…æ™°çš„æŠ¥å‘Šå±•ç¤º
- è¯¦ç»†çš„é”™è¯¯è¯´æ˜

### é«˜æ•ˆå¤„ç†
- æ‰¹é‡å¤„ç†èƒ½åŠ›
- æ™ºèƒ½ç¼“å­˜æœºåˆ¶
- å¿«é€Ÿå“åº”æ—¶é—´

## åº”ç”¨åœºæ™¯

### å­¦æœ¯å†™ä½œ
- å­¦ä½è®ºæ–‡æ ¼å¼æ£€æŸ¥
- å­¦æœ¯æœŸåˆŠæŠ•ç¨¿å‡†å¤‡
- ç ”ç©¶æŠ¥å‘Šè§„èŒƒåŒ–

### ç¼–è¾‘æ ¡å¯¹
- å‡ºç‰ˆç¤¾è´¨é‡æ§åˆ¶
- æœŸåˆŠç¼–è¾‘è¾…åŠ©å·¥å…·
- å­¦æœ¯ç¼–è¾‘å·¥ä½œæ”¯æŒ

### æ•™å­¦è¾…åŠ©
- å­¦ç”Ÿè®ºæ–‡å†™ä½œæŒ‡å¯¼
- å¼•ç”¨è§„èŒƒæ•™è‚²
- å­¦æœ¯è¯šä¿¡åŸ¹å…»

## å·¥ä½œæµç¨‹

1. **ä¸Šä¼ æ–‡æ¡£** - å°† Word æ–‡æ¡£ä¸Šä¼ åˆ°ç³»ç»Ÿ
2. **è‡ªåŠ¨åˆ†æ** - ç³»ç»Ÿè§£ææ–‡æ¡£ï¼Œæå–å¼•æ–‡å’Œå‚è€ƒæ–‡çŒ®
3. **æ™ºèƒ½åŒ¹é…** - AI ç®—æ³•è¿›è¡Œå¼•æ–‡åŒ¹é…å’Œæ ¼å¼ä¼˜åŒ–
4. **ç”ŸæˆæŠ¥å‘Š** - è¾“å‡ºè¯¦ç»†çš„åˆ†æå’Œä¿®æ­£å»ºè®®
5. **æ ¼å¼ä¿®æ­£** - æ ¹æ®å»ºè®®ä¿®æ­£ä¸è§„èŒƒçš„å¼•æ–‡

## ä½¿ç”¨æ•ˆæœ

ä½¿ç”¨æœ¬ç³»ç»Ÿåï¼Œç”¨æˆ·å¯ä»¥è·å¾—ï¼š
- **100%** çš„å¼•æ–‡åŒ¹é…æ£€æµ‹
- **95%+** çš„é«˜åŒ¹é…å‡†ç¡®ç‡
- **æ ‡å‡†åŒ–** çš„å¼•æ–‡æ ¼å¼
- **åˆè§„æ€§** çš„å­¦æœ¯è§„èŒƒä¿è¯
- **é«˜æ•ˆæ€§** çš„æ–‡æ¡£å¤„ç†é€Ÿåº¦



*æœ¬ç³»ç»Ÿä¸“æ³¨äºæé«˜å­¦æœ¯å†™ä½œçš„è§„èŒƒæ€§å’Œå‡†ç¡®æ€§ï¼Œæ˜¯ç ”ç©¶äººå‘˜ã€ç¼–è¾‘å’Œå­¦ç”Ÿçš„é‡è¦è¾…åŠ©å·¥å…·ã€‚*`;

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨å’Œç»‘å®šå…³äºæŒ‰é’®äº‹ä»¶
        window.addEventListener('DOMContentLoaded', function() {
            // å°† README å†…å®¹è½¬æ¢ä¸º HTML å¹¶æ˜¾ç¤ºåœ¨æ¨¡æ€æ¡†ä¸­
            const aboutContentElement = document.getElementById('about-content');
            if (aboutContentElement) {
                aboutContentElement.innerHTML = marked.parse(readmeContent);
            }

            // é€‰æ‹©æ–‡ä»¶å‡½æ•°
            function selectFile(filePath) {
                selectedFilePath = filePath;

                // æ›´æ–°UIä»¥åæ˜ é€‰æ‹©çŠ¶æ€
                document.querySelectorAll('.file-list-item').forEach(item => {
                    const itemPath = decodeURIComponent(item.getAttribute('data-filepath'));
                    if (itemPath === filePath) {
                        item.style.backgroundColor = '#dbeafe'; // é€‰ä¸­çŠ¶æ€çš„èƒŒæ™¯è‰²
                    } else {
                        item.style.backgroundColor = ''; // æ¢å¤é»˜è®¤èƒŒæ™¯è‰²
                    }
                });

                // å¯ç”¨åˆ†ææŒ‰é’®
                citationAnalyzeBtn.disabled = false;
                relevanceAnalyzeBtn.disabled = false;

                // éšè—ç›¸å…³æ€§æ£€æŸ¥åŒºåŸŸï¼ˆåªåœ¨ç‚¹å‡»ç›¸å…³æ€§åˆ†ææŒ‰é’®æ—¶æ˜¾ç¤ºï¼‰
                hideRelevanceCheckSection();
                disableRelevanceCheckButtons();

                log('å·²é€‰æ‹©æ–‡ä»¶ï¼š' + filePath.split('/').pop());
            }

            // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
            function displayFileList(files) {
                if (!files || files.length === 0) {
                    fileListContainer.innerHTML = '<p>æš‚æ— ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶</p>';
                    // ç¦ç”¨åˆ†ææŒ‰é’®ï¼Œå› ä¸ºæ²¡æœ‰å¯é€‰æ‹©çš„æ–‡ä»¶
                    citationAnalyzeBtn.disabled = true;
                    relevanceAnalyzeBtn.disabled = true;
                    return;
                }

                let html = '<ul style="list-style: none; padding: 0; margin: 10px 0;">';
                files.forEach(fileObj => {
                    // ä½¿ç”¨åç«¯è¿”å›çš„nameå­—æ®µï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»pathä¸­æå–
                    const fileName = fileObj.name || fileObj.path.replace(/^.*[\\/]/, '');
                    const filePath = fileObj.path; // ä½¿ç”¨å¯¹è±¡çš„pathå­—æ®µ
                    // é«˜äº®æ˜¾ç¤ºå½“å‰é€‰æ‹©çš„æ–‡ä»¶
                    const isSelected = selectedFilePath === filePath ? 'background-color: #dbeafe;' : '';
                    html += `
                        <li style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0; ${isSelected}"
                            data-filepath="${encodeURIComponent(filePath)}" class="file-list-item">
                            <span title="${filePath}" class="file-name-clickable" data-filepath="${encodeURIComponent(filePath)}"
                                style="cursor: pointer; color: #2563eb; text-decoration: underline; flex: 1;">
                                ${fileName}
                            </span>
                            <div>
                                <button class="select-file-btn" data-filepath="${encodeURIComponent(filePath)}"
                                    style="padding: 4px 10px; font-size: 0.8rem; background: linear-gradient(135deg, #3b82f6, #60a5fa); margin-right: 8px;">é€‰æ‹©</button>
                                <button class="analyze-file-btn" data-filepath="${encodeURIComponent(filePath)}"
                                    style="padding: 4px 10px; font-size: 0.8rem; background: linear-gradient(135deg, #10b981, #34d399); margin-right: 8px;">åˆ†æ</button>
                                <button class="delete-single-file-btn" data-filepath="${encodeURIComponent(filePath)}"
                                    style="padding: 4px 10px; font-size: 0.8rem; background: linear-gradient(135deg, #e11d48, #f87171);">åˆ é™¤</button>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';

                fileListContainer.innerHTML = html;

                // ä¸ºåˆ é™¤å•ä¸ªæ–‡ä»¶æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                document.querySelectorAll('.delete-single-file-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const filePath = decodeURIComponent(this.getAttribute('data-filepath'));
                        deleteSingleFile(filePath);
                    });
                });

                // ä¸ºé€‰æ‹©æ–‡ä»¶æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                document.querySelectorAll('.select-file-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const filePath = decodeURIComponent(this.getAttribute('data-filepath'));
                        selectFile(filePath);
                    });
                });

                // ä¸ºåˆ†æå•ä¸ªæ–‡ä»¶æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                document.querySelectorAll('.analyze-file-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const filePath = decodeURIComponent(this.getAttribute('data-filepath'));
                        selectFile(filePath); // å…ˆé€‰æ‹©æ–‡ä»¶
                        analyzeFileFromList(filePath); // ç„¶ååˆ†æ
                    });
                });

                // ä¸ºæ–‡ä»¶åæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œç‚¹å‡»åé€‰æ‹©æ–‡ä»¶
                document.querySelectorAll('.file-name-clickable').forEach(span => {
                    span.addEventListener('click', function() {
                        const filePath = decodeURIComponent(this.getAttribute('data-filepath'));
                        selectFile(filePath);
                    });
                });

                // ä¸ºæ•´ä¸ªæ–‡ä»¶åˆ—è¡¨é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»åé€‰æ‹©æ–‡ä»¶
                document.querySelectorAll('.file-list-item').forEach(item => {
                    item.addEventListener('click', function(event) {
                        // é˜²æ­¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶å†’æ³¡å¯¼è‡´é‡å¤å¤„ç†
                        if (event.target.tagName !== 'BUTTON') {
                            const filePath = decodeURIComponent(this.getAttribute('data-filepath'));
                            selectFile(filePath);
                        }
                    });
                });
            }

            // åˆ·æ–°ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
            function loadFileList() {
                const serverUrl = defaultBase.trim().replace(/\/$/, '');
                const listUrl = serverUrl + '/api/list-all-files';

                refreshFilesBtn.disabled = true;
                fileListContainer.innerHTML = '<p>æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</p>';

                const xhr = new XMLHttpRequest();
                xhr.open('GET', listUrl, true);

                xhr.onreadystatechange = () => {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        refreshFilesBtn.disabled = false;
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                if (response.files && response.files.length > 0) {
                                    displayFileList(response.files);
                                } else {
                                    fileListContainer.innerHTML = '<p>æš‚æ— ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶</p>';
                                    // æ²¡æœ‰æ–‡ä»¶æ—¶éšè—ç›¸å…³æ€§æ£€æŸ¥åŒºåŸŸ
                                    hideRelevanceCheckSection();
                                    disableRelevanceCheckButtons();
                                    selectedFilePath = null;
                                }
                            } catch (err) {
                                fileListContainer.innerHTML = '<p>åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š' + err.message + '</p>';
                            }
                        } else {
                            fileListContainer.innerHTML = '<p>è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š' + (xhr.responseText || ('çŠ¶æ€ç  ' + xhr.status)) + '</p>';
                        }
                    }
                };

                xhr.onerror = () => {
                    refreshFilesBtn.disabled = false;
                    fileListContainer.innerHTML = '<p>ç½‘ç»œå¼‚å¸¸ï¼ŒåŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥ã€‚</p>';
                };

                xhr.send();
            }

            // å½“é€‰æ‹©æ–‡ä»¶åï¼Œæ˜¾ç¤ºç›¸å…³æ€§æ£€æŸ¥åŒºåŸŸ
            function showRelevanceCheckSection() {
                console.log('showRelevanceCheckSection è¢«è°ƒç”¨');
                const element = document.getElementById('relevance-check-section');
                if (element) {
                    console.log('æ‰¾åˆ°ç›¸å…³æ€§æ£€æŸ¥åŒºåŸŸå…ƒç´ ï¼Œè®¾ç½®ä¸º block');
                    element.style.display = 'block';
                } else {
                    console.error('æœªæ‰¾åˆ°ç›¸å…³æ€§æ£€æŸ¥åŒºåŸŸå…ƒç´ ');
                }
            }

            // å½“å–æ¶ˆé€‰æ‹©æ–‡ä»¶åï¼Œéšè—ç›¸å…³æ€§æ£€æŸ¥åŒºåŸŸ
            function hideRelevanceCheckSection() {
                console.log('hideRelevanceCheckSection è¢«è°ƒç”¨');
                const element = document.getElementById('relevance-check-section');
                if (element) {
                    console.log('æ‰¾åˆ°ç›¸å…³æ€§æ£€æŸ¥åŒºåŸŸå…ƒç´ ï¼Œè®¾ç½®ä¸º none');
                    element.style.display = 'none';
                } else {
                    console.error('æœªæ‰¾åˆ°ç›¸å…³æ€§æ£€æŸ¥åŒºåŸŸå…ƒç´ ');
                }
            }

            // å¯ç”¨ç›¸å…³æ€§æ£€æŸ¥æŒ‰é’®
            function enableRelevanceCheckButtons() {
                document.getElementById('quick-check-btn').disabled = false;
                document.getElementById('accurate-check-btn').disabled = false;
            }

            // ç¦ç”¨ç›¸å…³æ€§æ£€æŸ¥æŒ‰é’®
            function disableRelevanceCheckButtons() {
                document.getElementById('quick-check-btn').disabled = true;
                document.getElementById('accurate-check-btn').disabled = true;
            }

            // ç›¸å…³æ€§æ£€æŸ¥å‡½æ•°
            function performRelevanceCheck(useFullContent) {
                if (!selectedFilePath) {
                    log('è¯·å…ˆä»æ–‡ä»¶åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæ–‡æ¡£è¿›è¡Œåˆ†æã€‚');
                    return;
                }

                const selectedCitation = document.getElementById('selected-citation').value;
                if (!selectedCitation) {
                    log('è¯·é€‰æ‹©è¦æ£€æŸ¥çš„æ–‡çŒ®ã€‚');
                    return;
                }

                const taskType = document.querySelector('input[name="task-type"]:checked').value;

                const serverUrl = defaultBase.trim().replace(/\/$/, '');
                const relevanceCheckUrl = serverUrl + '/api/relevance-check';

                const formData = new FormData();
                formData.append('file_path', selectedFilePath);
                // ä½¿ç”¨é€‰ä¸­çš„æ–‡çŒ®ä½œä¸ºç›®æ ‡å†…å®¹
                formData.append('target_content', selectedCitation);
                formData.append('task_type', taskType);
                formData.append('use_full_content', useFullContent);

                setBar(uploadProgress, 0);
                setBar(analysisProgress, 0);
                resultBox.hidden = true;
                log(`å¼€å§‹${useFullContent ? 'å‡†ç¡®' : 'å¿«é€Ÿ'}ç›¸å…³æ€§æ£€æŸ¥ï¼Œæ£€æŸ¥æ–‡çŒ®ï¼š${selectedCitation.substring(0, 30)}...`);

                // ç¦ç”¨ç›¸å…³æ€§æ£€æŸ¥æŒ‰é’®
                disableRelevanceCheckButtons();

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const quickBtn = document.getElementById('quick-check-btn');
                const accurateBtn = document.getElementById('accurate-check-btn');
                const originalQuickText = quickBtn.textContent;
                const originalAccurateText = accurateBtn.textContent;

                if (useFullContent) {
                    accurateBtn.textContent = 'æ£€æŸ¥ä¸­...';
                } else {
                    quickBtn.textContent = 'æ£€æŸ¥ä¸­...';
                }

                const xhr = new XMLHttpRequest();

                // æ¨¡æ‹Ÿåˆ†æè¿›åº¦
                const progressInterval = setInterval(() => {
                    if (xhr.readyState < 4) {
                        const currentProgress = parseFloat(analysisProgress.style.width || '0');
                        if (currentProgress < 90) {
                            setBar(analysisProgress, currentProgress + 2);
                        }
                    }
                }, 500);

                xhr.onreadystatechange = () => {
                    if (xhr.readyState !== XMLHttpRequest.DONE) return;

                    clearInterval(progressInterval);

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    quickBtn.textContent = originalQuickText;
                    accurateBtn.textContent = originalAccurateText;

                    // å¯ç”¨ç›¸å…³æ€§æ£€æŸ¥æŒ‰é’®
                    enableRelevanceCheckButtons();

                    if (xhr.status === 200) {
                        setBar(uploadProgress, 100);
                        setBar(analysisProgress, 100);
                        log('ç›¸å…³æ€§æ£€æŸ¥å®Œæˆã€‚');
                        try {
                            const payload = JSON.parse(xhr.responseText);
                            renderRelevanceResult(payload);
                        } catch (err) {
                            log('å“åº”è§£æå¤±è´¥ï¼š' + err.message);
                        }
                    } else {
                        log('è¯·æ±‚å¤±è´¥ï¼š' + (xhr.responseText || ('çŠ¶æ€ç  ' + xhr.status)));
                    }
                };

                xhr.onerror = () => {
                    clearInterval(progressInterval);
                    quickBtn.textContent = originalQuickText;
                    accurateBtn.textContent = originalAccurateText;
                    enableRelevanceCheckButtons();
                    log('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¡®è®¤åç«¯æœåŠ¡å¯è®¿é—®ã€‚');
                };

                xhr.open('POST', relevanceCheckUrl, true);
                xhr.send(formData);
            }

            // æ¸²æŸ“ç›¸å…³æ€§æ£€æŸ¥ç»“æœ
            function renderRelevanceResult(payload) {
                resultGrid.innerHTML = '';

                if (typeof marked === 'undefined') {
                    log('é”™è¯¯ï¼šmarked åº“æœªåŠ è½½');
                    resultRaw.textContent = 'Markdown æ¸²æŸ“åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                    resultBox.hidden = false;
                    return;
                }

                // ç”Ÿæˆç›¸å…³æ€§æ£€æŸ¥æŠ¥å‘Šçš„ Markdown å†…å®¹
                let markdownContent = '# æ–‡çŒ®ç›¸å…³æ€§æ£€æŸ¥æŠ¥å‘Š\n\n';

                if (payload.document) {
                    // æå–æ–‡ä»¶åè€Œä¸æ˜¯å®Œæ•´è·¯å¾„
                    const documentFileName = payload.document.split('/').pop();
                    markdownContent += `- **æ–‡æ¡£**: ${escapeHtml(documentFileName)}\n`;
                }
                if (payload.test_date) {
                    // æ ¼å¼åŒ–æ—¥æœŸä¸º "YYYYå¹´MMæœˆDDæ—¥ HH:mm:ss" æ ¼å¼
                    const date = new Date(payload.test_date);
                    const formattedDate = `${date.getFullYear()}å¹´${(date.getMonth() + 1).toString().padStart(2, '0')}æœˆ${date.getDate().toString().padStart(2, '0')}æ—¥ ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
                    markdownContent += `- **ç”Ÿæˆæ—¶é—´**: ${formattedDate}\n`;
                }
                if (payload.task_type) {
                    markdownContent += `- **ä»»åŠ¡ç±»å‹**: ${escapeHtml(payload.task_type)}\n`;
                }
                // ç§»é™¤æ£€æŸ¥æ–¹æ³•çš„æ˜¾ç¤º

                markdownContent += '**ç›¸å…³æ€§åˆ†æç»“æœ**\n\n';
                markdownContent += '| æŒ‡æ ‡ | æ•°å€¼ |\n';
                markdownContent += '| --- | --- |\n';
                if (payload.relevance_score) markdownContent += `| ç›¸å…³æ€§è¯„åˆ† | ${payload.relevance_score}/10 |\n`;
                if (payload.is_suitable_for_citation !== undefined) markdownContent += `| æ˜¯å¦é€‚åˆå¼•ç”¨ | ${payload.is_suitable_for_citation ? 'æ˜¯' : 'å¦'} |\n`;
                markdownContent += '\n';

                if (payload.brief_basis) {
                    markdownContent += `**ç®€è¦ä¾æ®**: ${escapeHtml(payload.brief_basis)}\n\n`;
                }

                if (payload.detailed_reasoning) {
                    markdownContent += `**è¯¦ç»†ç†ç”±**: ${escapeHtml(payload.detailed_reasoning)}\n\n`;
                }

                // ä¿å­˜ Markdown å†…å®¹ç”¨äºä¸‹è½½
                lastMarkdown = markdownContent;

                try {
                    // ä½¿ç”¨ marked åº“å°† Markdown æ¸²æŸ“ä¸º HTML
                    const renderedHTML = marked.parse(markdownContent);
                    resultRaw.innerHTML = renderedHTML;
                } catch (error) {
                    console.error('Markdown è§£æé”™è¯¯:', error);
                    resultRaw.textContent = markdownContent;
                }

                // æ›´æ–°ç»“æœç½‘æ ¼
                const mapping = [
                    ['ç›¸å…³æ€§è¯„åˆ†', `${payload.relevance_score}/10`],
                    ['æ˜¯å¦é€‚åˆå¼•ç”¨', payload.is_suitable_for_citation ? 'æ˜¯' : 'å¦'],
                    ['ä»»åŠ¡ç±»å‹', payload.task_type],
                    ['æ£€æŸ¥æ–¹æ³•', payload.check_method],
                ];

                mapping.forEach(([label, value]) => {
                    if (value !== undefined && value !== null) {
                        const chip = document.createElement('div');
                        chip.className = 'result-chip';
                        chip.textContent = label + 'ï¼š' + value;
                        resultGrid.appendChild(chip);
                    }
                });

                resultBox.hidden = false;
                downloadMdBtn.style.display = 'inline-block';
                downloadTxtBtn.style.display = 'inline-block';
            }

            // ä¸ºç›¸å…³æ€§æ£€æŸ¥æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('quick-check-btn').addEventListener('click', () => {
                performRelevanceCheck(false); // å¿«é€Ÿæ£€æµ‹ï¼ŒuseFullContent=false
            });

            document.getElementById('accurate-check-btn').addEventListener('click', () => {
                performRelevanceCheck(true); // å‡†ç¡®æ£€æŸ¥ï¼ŒuseFullContent=true
            });

            // å…³äºæŒ‰é’®äº‹ä»¶
            const aboutBtn = document.getElementById('about-btn');
            if (aboutBtn) {
                aboutBtn.addEventListener('click', function() {
                    const modal = document.getElementById('about-modal');
                    if (modal) {
                        modal.style.display = 'flex';
                    }
                });
            }

            // å…³é—­å…³äºæ¨¡æ€æ¡†äº‹ä»¶
            const closeAboutModalBtn = document.getElementById('close-about-modal');
            if (closeAboutModalBtn) {
                closeAboutModalBtn.addEventListener('click', function() {
                    const modal = document.getElementById('about-modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
            }

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
            const modal = document.getElementById('about-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            }

            // ä¸ºåˆ·æ–°æ–‡ä»¶åˆ—è¡¨æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            refreshFilesBtn.addEventListener('click', loadFileList);

            // ä¸Šä¼ æŒ‰é’®äº‹ä»¶
            uploadBtn.addEventListener('click', () => {
                const serverUrl = defaultBase.trim().replace(/\/$/, '');
                const file = fileInput.files[0];

                if (!file) {
                    log('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„ Word æ–‡æ¡£ã€‚');
                    return;
                }

                const uploadOnlyUrl = serverUrl + '/api/upload-only';

                const formData = new FormData();
                formData.append('file', file);

                setBar(uploadProgress, 0);
                setBar(analysisProgress, 0);
                log('å‡†å¤‡ä¸Šä¼ æ–‡ä»¶ï¼š' + file.name);

                uploadBtn.disabled = true;

                const xhr = new XMLHttpRequest();

                xhr.upload.onprogress = (evt) => {
                    if (!evt.lengthComputable) return;
                    const percent = (evt.loaded / evt.total) * 100;
                    setBar(uploadProgress, percent);

                    if (percent >= 99) {
                        log('ä¸Šä¼ å®Œæˆï¼Œæ­£åœ¨å¤„ç†...');
                    }
                };

                xhr.onreadystatechange = () => {
                    if (xhr.readyState !== XMLHttpRequest.DONE) return;

                    uploadBtn.disabled = false;

                    if (xhr.status === 200) {
                        setBar(uploadProgress, 100);
                        log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼');

                        // ä¸Šä¼ å®Œæˆåè‡ªåŠ¨åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                        loadFileList();
                    } else {
                        log('ä¸Šä¼ å¤±è´¥ï¼š' + (xhr.responseText || ('çŠ¶æ€ç  ' + xhr.status)));
                    }
                };

                xhr.onerror = () => {
                    uploadBtn.disabled = false;
                    log('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¡®è®¤åç«¯æœåŠ¡å¯è®¿é—®ã€‚');
                };

                xhr.open('POST', uploadOnlyUrl, true);
                xhr.send(formData);
            });

            // å¼•ç”¨åˆ†ææŒ‰é’®äº‹ä»¶
            citationAnalyzeBtn.addEventListener('click', () => {
                if (!selectedFilePath) {
                    log('è¯·å…ˆä»æ–‡ä»¶åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæ–‡æ¡£è¿›è¡Œåˆ†æã€‚');
                    return;
                }

                const serverUrl = defaultBase.trim().replace(/\/$/, '');
                const analyzeUrl = serverUrl + '/api/full-report-from-path';

                // è·å–å½“å‰é€‰ä¸­çš„ä½œè€…æ ¼å¼
                const selectedAuthorFormat = document.querySelector('input[name="author-format"]:checked').value;

                // åˆ›å»ºè¡¨å•æ•°æ®
                const formData = new FormData();
                formData.append('file_path', selectedFilePath);
                formData.append('author_format', selectedAuthorFormat);

                setBar(uploadProgress, 0);
                setBar(analysisProgress, 0);
                resultBox.hidden = true;
                log('å‡†å¤‡è¿›è¡Œå¼•ç”¨åˆ†æï¼š' + selectedFilePath.split('/').pop() + 'ï¼Œä½œè€…æ ¼å¼è§„åˆ™ï¼š' + (selectedAuthorFormat === 'full' ? 'å®Œæ•´æ˜¾ç¤º' : 'ç®€ç•¥æ˜¾ç¤º'));

                citationAnalyzeBtn.disabled = true;

                // æ›´æ–°åˆ†ææŒ‰é’®çš„çŠ¶æ€
                const originalButtonText = citationAnalyzeBtn.textContent;
                citationAnalyzeBtn.textContent = 'åˆ†æä¸­...';

                const xhr = new XMLHttpRequest();

                // æ¨¡æ‹Ÿåˆ†æè¿›åº¦ï¼Œå› ä¸ºåç«¯ä¸æä¾›è¿›åº¦API
                const progressInterval = setInterval(() => {
                    if (xhr.readyState < 4) {
                        const currentProgress = parseFloat(analysisProgress.style.width || '0');
                        if (currentProgress < 90) { // ä¸åˆ°100%ï¼Œå› ä¸ºæˆ‘ä»¬è¦ç­‰å¾…å®é™…å“åº”
                            setBar(analysisProgress, currentProgress + 2);
                        }
                    }
                }, 500);

                xhr.onreadystatechange = () => {
                    if (xhr.readyState !== XMLHttpRequest.DONE) return;

                    clearInterval(progressInterval); // åœæ­¢æ¨¡æ‹Ÿè¿›åº¦

                    // æ¢å¤åˆ†ææŒ‰é’®çš„åŸå§‹çŠ¶æ€
                    citationAnalyzeBtn.disabled = false;
                    citationAnalyzeBtn.textContent = originalButtonText;

                    if (xhr.status === 200) {
                        setBar(uploadProgress, 100);
                        setBar(analysisProgress, 100);
                        log('å¼•ç”¨åˆ†æå®Œæˆã€‚');
                        try {
                            const payload = JSON.parse(xhr.responseText);
                            renderResult(payload);
                        } catch (err) {
                            log('å“åº”è§£æå¤±è´¥ï¼š' + err.message);
                        }
                    } else {
                        log('è¯·æ±‚å¤±è´¥ï¼š' + (xhr.responseText || ('çŠ¶æ€ç  ' + xhr.status)));
                    }
                };

                xhr.onerror = () => {
                    clearInterval(progressInterval); // åœæ­¢æ¨¡æ‹Ÿè¿›åº¦
                    citationAnalyzeBtn.disabled = false;
                    citationAnalyzeBtn.textContent = originalButtonText;
                    log('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¡®è®¤åç«¯æœåŠ¡å¯è®¿é—®ã€‚');
                };

                xhr.open('POST', analyzeUrl, true);
                xhr.send(formData);
            });

            // ç›¸å…³æ€§åˆ†ææŒ‰é’®äº‹ä»¶
            console.log('å‡†å¤‡ä¸ºç›¸å…³æ€§åˆ†ææŒ‰é’®ç»‘å®šäº‹ä»¶ç›‘å¬å™¨');
            if (relevanceAnalyzeBtn) {
                console.log('ç›¸å…³æ€§åˆ†ææŒ‰é’®å…ƒç´ å­˜åœ¨');
                relevanceAnalyzeBtn.addEventListener('click', () => {
                    console.log('ç›¸å…³æ€§åˆ†ææŒ‰é’®è¢«ç‚¹å‡»');
                    console.log('selectedFilePath:', selectedFilePath);
                    if (!selectedFilePath) {
                        log('è¯·å…ˆä»æ–‡ä»¶åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæ–‡æ¡£è¿›è¡Œç›¸å…³æ€§åˆ†æã€‚');
                        return;
                    }

                    // æ˜¾ç¤ºç›¸å…³æ€§æ£€æŸ¥åŒºåŸŸ
                    console.log('è°ƒç”¨ showRelevanceCheckSection');
                    showRelevanceCheckSection();
                    enableRelevanceCheckButtons();

                    // æ›´æ–°ç›¸å…³æ€§æ£€æŸ¥åŒºåŸŸä¸­çš„æ–‡æ¡£åç§°
                    const fileName = selectedFilePath.split('/').pop();
                    document.getElementById('relevance-doc-name').textContent = fileName;

                    // æå–æ–‡æ¡£ä¸­çš„å¼•ç”¨æ–‡çŒ®å¹¶å¡«å……é€‰æ‹©æ¡†
                    extractCitationsFromDocument(selectedFilePath);

                    log('å·²å‡†å¤‡ç›¸å…³æ€§åˆ†æï¼Œè¯·åœ¨ä¸‹æ–¹é€‰æ‹©æ–‡çŒ®å¹¶è¿›è¡Œæ£€æŸ¥ã€‚');
                });
                console.log('ç›¸å…³æ€§åˆ†ææŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
            } else {
                console.error('ç›¸å…³æ€§åˆ†ææŒ‰é’®å…ƒç´ ä¸å­˜åœ¨');
            }

            // åˆ é™¤ä¸Šä¼ æ–‡ä»¶åŠŸèƒ½
            deleteBtn.addEventListener('click', () => {
                if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    return;
                }

                const serverUrl = defaultBase.trim().replace(/\/$/, '');
                const deleteUrl = serverUrl + '/api/files-by-pattern?directory=temp_uploads';

                deleteBtn.disabled = true;
                log('æ­£åœ¨æ¸…ç©ºä¸Šä¼ æ–‡ä»¶...');

                const xhr = new XMLHttpRequest();
                xhr.open('DELETE', deleteUrl, true);

                xhr.onreadystatechange = () => {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        deleteBtn.disabled = false;
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                log(`æˆåŠŸæ¸…ç©ºä¸Šä¼ æ–‡ä»¶: ${response.deleted_count} ä¸ªæ–‡ä»¶å·²è¢«åˆ é™¤`);
                                // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                                loadFileList();
                            } catch (err) {
                                log('æ¸…ç©ºä¸Šä¼ æ–‡ä»¶æˆåŠŸï¼Œä½†å“åº”è§£æå¤±è´¥ï¼š' + err.message);
                            }
                        } else {
                            log('æ¸…ç©ºä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼š' + (xhr.responseText || ('çŠ¶æ€ç  ' + xhr.status)));
                        }
                    }
                };

                xhr.onerror = () => {
                    deleteBtn.disabled = false;
                    log('ç½‘ç»œå¼‚å¸¸ï¼Œæ¸…ç©ºä¸Šä¼ æ–‡ä»¶å¤±è´¥ã€‚');
                };

                xhr.send();
            });

            // é¡µé¢åŠ è½½å®Œæˆåéšè—ç›¸å…³æ€§æ£€æŸ¥åŒºåŸŸ
            hideRelevanceCheckSection();
            disableRelevanceCheckButtons();

            // åŸæ¥çš„åŠ è½½æ–‡ä»¶åˆ—è¡¨åŠŸèƒ½
            loadFileList();
        });
    </script>

    <!-- å…³äºæ¨¡æ€æ¡† -->
    <div id="about-modal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; border-radius: 12px; width: 80%; max-width: 800px; max-height: 80vh; overflow: auto; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin: 0; color: #0f172a;">å¼•æ–‡åˆè§„æ€§æ£€æŸ¥ç³»ç»Ÿ - åŠŸèƒ½ä»‹ç»</h2>
                    <button id="close-about-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
                </div>
                <div id="about-content" style="color: #334155; line-height: 1.6;">
                    <!-- README å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>

